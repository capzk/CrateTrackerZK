# CrateTrackerZK 项目规则文档

## 项目概述

**CrateTrackerZK** 是一个魔兽世界插件，用于自动追踪战争物资空投箱的刷新时间和位面信息。

**核心功能**：
- 自动检测：通过地图图标（Vignette）系统自动检测空投箱子
- 时间追踪：记录和计算刷新时间（默认间隔1100秒）
- 位面追踪：检测和显示当前位面ID
- 团队通知：支持团队/小队通知功能
- 多语言支持：zhCN/zhTW/enUS/ruRU

**版本**：1.1.3-rev1  
**接口版本**：110200, 110205, 110207

---

## 架构设计

### 模块化分层架构

```
核心层 (Core)
  ├─ Core.lua - 事件处理、初始化协调
  │
数据层 (Data)
  ├─ MapConfig.lua - 地图配置（7个地图，间隔1100秒）
  └─ Data.lua - 数据管理、时间计算、持久化
  │
功能层 (Modules)
  ├─ Timer.lua - 检测循环协调（每1秒）
  ├─ IconDetector.lua - 图标检测（仅名称匹配）
  ├─ MapTracker.lua - 地图匹配（支持父地图）
  ├─ DetectionState.lua - 状态机管理
  ├─ Notification.lua - 通知系统
  ├─ Phase.lua - 位面检测
  ├─ Area.lua - 区域有效性检测
  └─ Commands.lua - 命令处理
  │
  ⚠️ 已移除：NotificationCooldown.lua（通知冷却期机制已移除）
  │
UI层 (UI)
  ├─ MainPanel.lua - 主面板（每秒更新）
  ├─ FloatingButton.lua - 浮动按钮
  └─ Info.lua - 帮助信息
  │
工具层 (Utils)
  ├─ Logger.lua - 统一日志系统（限流支持）
  ├─ Localization.lua - 本地化管理
  └─ Utils.lua - 通用工具函数
```

### 模块通信机制

- **BuildEnv 系统**：所有模块通过 `BuildEnv(name)` 创建和访问
- **延迟加载**：模块在首次访问时创建
- **全局访问**：所有模块可访问其他模块，但需注意依赖顺序

### 文件加载顺序（Load.xml）

1. 基础工具（Utils/Utils.lua, Utils/Logger.lua）
2. 本地化系统（Utils/Localization.lua, Locales/*.lua）
3. 数据管理（Data/MapConfig.lua, Data/Data.lua）
4. 功能模块（按依赖顺序）
5. UI模块（Core/Core.lua, UI/*.lua）

---

## 核心运行逻辑

### 初始化流程

**PLAYER_LOGIN 事件触发**：
1. 初始化 SavedVariables（CRATETRACKERZK_DB, CRATETRACKERZK_UI_DB）
2. **关键**：清除所有内存检测状态（防止跨角色污染）
   - DetectionState:ClearAllStates()
   - MapTracker:Initialize()
   - Phase:Reset()
   - Area 状态重置
3. 初始化各模块（Localization, Data, Notification, Commands）
4. 启动检测系统（TimerManager:StartMapIconDetection(1)）
5. 创建UI界面
6. 检查区域有效性

### 检测循环（每1秒）

```
TimerManager:DetectMapIcons()
  ├─ 获取当前地图ID (C_Map.GetBestMapForUnit("player"))
  ├─ 匹配目标地图 (MapTracker:GetTargetMapData)
  │   └─ 支持父地图匹配
  ├─ 处理地图变化 (MapTracker:OnMapChanged)
  ├─ 检查 PROCESSED 状态（3分钟冷却期）
  ├─ 检测图标 (IconDetector:DetectIcon)
  │   └─ 仅依赖名称匹配，不检查位置
  ├─ 更新状态机 (DetectionState:UpdateState)
  │   └─ IDLE → DETECTING → CONFIRMED → PROCESSED
  └─ 如果 CONFIRMED：
      ├─ 发送通知（与刷新时间绑定）
      ├─ 更新刷新时间
      ├─ 更新UI显示（TimerManager:UpdateUI()）
      └─ 标记为 PROCESSED（暂停检测3分钟）
```

### 状态机（DetectionState）

**状态转换**：
- `IDLE` → `DETECTING`：首次检测到图标
- `DETECTING` → `CONFIRMED`：持续检测2秒
- `CONFIRMED` → `PROCESSED`：已更新时间和通知
- `PROCESSED` → `IDLE`：3分钟后（超时自动清除）

**关键机制**：
- **2秒确认期**：防止短暂图标闪烁误判
- **3分钟冷却期**：PROCESSED 状态下暂停检测（180秒），防止重复检测和通知
- **消失确认期**：CONFIRMED 5秒，ACTIVE 5分钟（空投是持续事件）
- **通知机制**：通知与空投检测绑定，确认空投后同时发送通知和更新刷新时间

### 区域有效性检测（Area）

**无效区域**（自动暂停检测）：
- 副本类型：party, raid, pvp, arena, scenario
- 无法获取地图ID
- 当前地图不在追踪列表中（且父地图也不在）

**有效区域**（恢复检测）：
- 不是副本/战场
- 当前地图在追踪列表中（或父地图在列表中）
- **注意**：室内区域不再被视为无效

### 位面检测（Phase）

**检测方法**：
- 从NPC的GUID提取位面信息
- GUID格式：`Creature-服务器ID-实例ID-...`
- 位面ID = `服务器ID-实例ID`

**触发时机**：
- 区域变化（ZONE_CHANGED, ZONE_CHANGED_NEW_AREA）
- 目标改变（PLAYER_TARGET_CHANGED）
- 鼠标悬停NPC（工具提示显示）

---

## 数据管理

### 数据结构

**内存数据（Data.maps）**：
```lua
{
  [id] = {
    id = 1,                    -- 内部ID（从1开始）
    mapID = 2248,             -- 游戏地图ID
    interval = 1100,          -- 刷新间隔（秒）
    instance = "123-456",     -- 当前位面
    lastInstance = "123-456", -- 上次位面
    lastRefreshInstance = "123-456", -- 上次刷新时的位面
    lastRefresh = timestamp,  -- 上次刷新时间戳
    nextRefresh = timestamp,  -- 下次刷新时间戳（计算得出）
    createTime = timestamp    -- 创建时间
  }
}
```

**持久化数据（SavedVariables）**：
- `CRATETRACKERZK_DB`：地图数据（所有角色共享）
- `CRATETRACKERZK_UI_DB`：UI设置（所有角色共享）

**内存状态（不持久化，每次登录清除）**：
- DetectionState 的检测状态
- MapTracker 的地图追踪状态
- Phase 的位面检测状态

### 时间计算逻辑

```
nextRefresh = lastRefresh + n * interval

其中：
- lastRefresh: 上次刷新时间戳
- interval: 刷新间隔（默认1100秒）
- n: 计算出的刷新次数

n 的计算：
- 如果 lastRefresh < currentTime:
  n = ceil((currentTime - lastRefresh) / interval)
- 如果 lastRefresh >= currentTime:
  向前计算，找到最接近当前时间的未来刷新点
```

### 数据更新流程

**自动检测更新**：
1. 检测到图标 → 2秒确认 → CONFIRMED
2. Data:SetLastRefresh(mapId, firstDetectedTime)
3. Data:UpdateNextRefresh(mapId)
4. Data:SaveMapData(mapId)
5. TimerManager:UpdateUI() → MainPanel:UpdateTable()（如果主面板显示，立即更新；如果未显示，下次打开时通过定时器更新）

**刷新按钮更新**（优化后）：
1. 立即更新内存数据（同步）
2. 立即更新UI显示（同步）
3. 异步保存数据（C_Timer.After(0, ...)）

**手动输入更新**：
1. 解析时间输入（HH:MM:SS 或 HHMMSS）
2. 转换为时间戳
3. TimerManager:StartTimer(mapId, MANUAL_INPUT, timestamp)

---

## 关键设计原则

### 1. 状态隔离原则

**全局数据（SavedVariables）**：
- ✅ 所有角色共享（刷新时间、位面信息）
- ✅ 持久化保存

**内存状态（模块变量）**：
- ✅ 每个角色独立（检测状态、追踪状态）
- ✅ 每次登录时清除（防止跨角色污染）

### 2. 防误触机制

- **2秒持续检测确认**：防止短暂图标闪烁误判
- **消失确认期**：CONFIRMED 5秒，ACTIVE 5分钟
- **通知机制**：通知与空投检测绑定，确认空投后同时发送通知和更新刷新时间
- **3分钟冷却期**：PROCESSED 状态下暂停检测（180秒），防止重复检测和通知

### 3. 检测原理

**图标检测**：
- 仅依赖名称匹配（"War Supply Crate" / "战争物资箱"）
- 不检查位置信息（支持子地图场景）
- 使用 `C_VignetteInfo.GetVignettes()` 获取所有图标

**地图匹配**：
- 支持直接地图ID匹配
- 支持父地图匹配（子地图继承父地图配置）

### 4. 通知系统

**自动检测通知**（受 `/ctk team on/off` 控制）：
- 聊天框：始终发送
- 团队中：RAID + RAID_WARNING（如果启用）
- 小队中：不发送自动消息

**手动通知**（不受命令控制）：
- 在队伍中：发送到队伍（PARTY/RAID/INSTANCE_CHAT）
- 不在队伍中：发送到聊天框

### 5. 日志系统

**日志级别**：
- ERROR（红色）
- WARN（橙色）
- INFO（蓝色）
- DEBUG（绿色，需开启调试模式）
- SUCCESS（绿色）

**限流机制**：
- 不同类型消息不同限流间隔
- 限流消息统计（显示被限流的消息数量）
- 调试模式可开关（持久化到 CRATETRACKERZK_UI_DB）

---

## 重要约束和注意事项

### 1. 角色切换问题（已修复）

**问题**：内存检测状态跨角色共享导致检测异常

**解决方案**：
- 每次 `PLAYER_LOGIN` 时清除所有内存检测状态
- 保留全局 SavedVariables 数据（刷新时间共享）

### 2. 地图配置

**当前支持的地图**（Data/MapConfig.lua）：
- 多恩岛 (2248)
- 海妖岛 (2369)
- 卡雷什 (2371)
- 安德麦 (2346)
- 陨圣峪 (2215)
- 喧鸣深窟 (2214)
- 艾基-卡赫特 (2255)

所有地图使用相同刷新间隔：1100秒

### 3. 空投箱子配置

**代码**：`WarSupplyCrate`  
**名称**：通过本地化系统获取（"War Supply Crate" / "战争物资箱"）

### 4. 时间输入格式

支持两种格式：
- `HH:MM:SS`（如：14:30:00）
- `HHMMSS`（如：143000）

### 5. 版本号规范

**正式版（main分支）**：`x.y.z`（如：1.1.3）  
**开发版（dev分支）**：`x.y.z-dev`（如：1.1.3-dev）

---

## 常用命令

- `/ctk` 或 `/ct` - 打开/关闭主面板
- `/ctk help` - 显示帮助信息
- `/ctk clear` - 清除所有数据并重新初始化
- `/ctk team on/off` - 开启/关闭团队通知
- `/ctk debug on/off` - 开启/关闭调试模式

---

## 开发指南

### 添加新地图

1. 在 `Data/MapConfig.lua` 的 `current_maps` 中添加配置
2. 在 `Locales/*.lua` 的 `MapNames` 中添加地图名称翻译
3. 无需修改其他代码

### 添加新语言

1. 创建 `Locales/xxXX.lua` 文件
2. 在 `Load.xml` 中添加加载语句（在 enUS.lua 之前）
3. 实现完整的翻译表（参考 enUS.lua）

### 修改检测逻辑

**关键文件**：
- `Modules/Timer.lua` - 检测循环协调
- `Modules/IconDetector.lua` - 图标检测
- `Modules/DetectionState.lua` - 状态机管理

**注意事项**：
- 保持状态机的完整性
- 注意防误触机制
- 考虑跨角色状态隔离

### 调试技巧

1. 开启调试模式：`/ctk debug on`
2. 查看日志输出（带颜色和模块前缀）
3. 使用限流日志避免刷屏
4. 检查状态机状态（DetectionState:GetState）

---

## 关键API使用

### 地图系统
- `C_Map.GetBestMapForUnit("player")` - 获取当前地图ID
- `C_Map.GetMapInfo(mapID)` - 获取地图信息

### 图标检测
- `C_VignetteInfo.GetVignettes()` - 获取所有图标GUID
- `C_VignetteInfo.GetVignetteInfo(guid)` - 获取图标信息

### 定时器
- `C_Timer.NewTicker(interval, callback)` - 创建周期性定时器
- `C_Timer.After(delay, callback)` - 延迟执行

### 位面检测
- `UnitGUID("mouseover")` 或 `UnitGUID("target")` - 获取单位GUID
- 解析GUID：`strsplit("-", guid)` - 提取位面信息

---

## 常见问题

### Q: 为什么检测不到空投？
A: 检查以下几点：
1. 是否在有效区域（非副本/战场）
2. 当前地图是否在追踪列表中
3. 是否处于 PROCESSED 状态（3分钟冷却期）
4. 调试模式查看详细日志

### Q: 为什么切换角色后检测异常？
A: 已修复。每次登录时会清除所有内存检测状态，确保每个角色独立。

### Q: 为什么通知没有发送？
A: 检查：
1. 自动通知：是否启用团队通知（`/ctk team on`）
2. 是否确认了空投（需要持续检测2秒）
3. 是否在团队中（自动通知仅在团队中发送）
4. 是否处于PROCESSED状态（3分钟冷却期内不会重复检测）

### Q: 如何清除所有数据？
A: 使用命令 `/ctk clear`，会清除所有刷新时间和位面数据，并重新初始化插件。

---

## 文档索引

详细文档位于 `docs/` 目录：
- `FUNCTIONALITY_AND_LOGIC.md` - 完整功能详解
- `RUNTIME_LOGIC.md` - 运行逻辑详解
- `MODULE_ARCHITECTURE.md` - 模块架构
- `DATA_FLOW.md` - 数据流
- `API_REFERENCE.md` - API参考
- `CHANGELOG.md` - 变更日志

---

## 最近优化记录

### 2024-12-19 - 清除机制优化

**优化内容**：
1. **修复clear命令**：使用`ClearAllStates()`清除所有状态（包括DETECTING、CONFIRMED、PROCESSED），而不是只清除PROCESSED状态
2. **简化清除机制**：移除冗余的清除逻辑，只保留三种必要的清除场景：
   - 角色切换/重新进入/重载（OnLogin()清除所有状态）
   - PROCESSED状态下暂停检测3分钟（超时自动清除）
   - `/ctk clear` 清除所有数据包括状态
3. **移除的功能**：
   - 地图切换时的状态清除（MapTracker.lua）
   - 离开地图超时清除（MapTracker.lua）
   - `mapLeftTime` 变量和 `CheckAndClearLeftMaps()` 函数
   - **NotificationCooldown模块**（已删除文件和相关引用）
4. **PROCESSED超时调整**：从5分钟（300秒）调整为3分钟（180秒）
5. **移除通知冷却期机制**：通知与空投检测绑定，确认空投后同时发送通知和更新刷新时间。防误报由2秒确认期和PROCESSED状态3分钟冷却期处理。

**修改的文件**：
- `Modules/Commands.lua` - 修复clear命令，移除NotificationCooldown引用
- `Modules/MapTracker.lua` - 移除地图切换清除和离开超时清除
- `Modules/Timer.lua` - 移除CheckAndClearLeftMaps调用，移除NotificationCooldown记录
- `Data/Data.lua` - 移除mapLeftTime和NotificationCooldown引用
- `Modules/DetectionState.lua` - PROCESSED_TIMEOUT从300秒改为180秒
- `Core/Core.lua` - 移除NotificationCooldown清除
- `Load.xml` - 移除NotificationCooldown模块加载
- `Utils/Logger.lua` - 移除NotificationCooldown模块前缀
- `Modules/NotificationCooldown.lua` - **已删除**（不再使用的模块）

**优化效果**：
- ✅ 代码更简洁：移除了冗余的清除逻辑和通知冷却期机制
- ✅ 逻辑更清晰：只保留必要的清除机制，通知与空投检测绑定
- ✅ 功能完整：clear命令现在正确清除所有状态
- ✅ 响应更快：PROCESSED冷却期从5分钟缩短到3分钟
- ✅ 通知机制简化：通知与刷新时间绑定，由2秒确认期和PROCESSED状态防止重复

---

**最后更新**：2024-12-19  
**维护者**：capzk

