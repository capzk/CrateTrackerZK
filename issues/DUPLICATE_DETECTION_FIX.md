# 重复检测问题修复

## 问题描述

### 问题现象
在一次空投事件持续期间（1-2分钟），可能会发生重复检测和重复通知的情况：
- 首次检测到空投，发送通知并更新时间 ✓
- 在空投结束前，由于某些原因导致重复发送通知和更新时间 ✗

### 根本原因
**子地图和父地图切换导致的重复检测**：

1. **地图配置情况**：
   - 只有父地图 2371（卡雷什）在配置中
   - 子地图 2472（塔扎维什）不在配置中
   - 两个地图都是有效区域

2. **触发场景**：
   - 空投发生在主地图（卡雷什 2371）
   - 玩家需要先经过子地图（塔扎维什 2472）才能到达主地图
   - 在子地图检测到空投 → 发送通知 + 更新时间
   - 到达主地图后，又检测到同一个空投 → 再次发送通知 + 更新时间
   - 使用传送门在子地图和主地图之间穿梭 → 每次都会触发检测

3. **问题本质**：
   - 同一个空投事件，但因为地图切换，Vignette API 可能短暂返回空列表
   - 代码立即清除 `mapIconDetected` 状态
   - 当 Vignette 重新出现时，重新开始检测流程
   - 导致重复通知和更新时间

## 解决方案

### 核心改进

1. **首次检测立即通知，2秒确认后更新时间**：
   - 首次检测到图标时立即发送通知（检查冷却期）
   - 不立即更新时间，等待2秒确认
   - 2秒确认后更新时间，不再次发送通知

2. **通知冷却期机制**：
   - 同一地图在120秒（2分钟）内不重复发送通知
   - 冷却期仅在首次检测时检查
   - 时间更新不受冷却期影响

3. **消失确认期机制**：
   - 已确认的空投需要持续消失5秒才清除状态
   - 防止因地图切换或API延迟导致的误清除
   - 如果图标在确认期内重新出现，保持状态

### 代码修改

**文件**: `Modules/Timer.lua`

**主要变更**:

1. **Initialize() 函数**：
   - 添加 `mapIconDisappearedTime` - 记录图标消失时间
   - 添加 `lastNotificationTime` - 记录上次通知时间
   - 添加 `DISAPPEAR_CONFIRM_TIME = 5` - 消失确认时间（秒）
   - 添加 `NOTIFICATION_COOLDOWN = 120` - 通知冷却时间（秒）

2. **DetectMapIcons() 函数**：
   - **首次检测逻辑**：
     - 记录首次检测时间
     - 检查通知冷却期
     - 如果不在冷却期内，立即发送通知
     - 不更新时间，等待2秒确认
   
   - **2秒确认逻辑**：
     - 持续检测2秒后确认
     - 更新时间（使用首次检测时间）
     - 设置 `mapIconDetected = true`
     - 不再次发送通知（首次已发送）
   
   - **图标消失处理**：
     - 如果已确认：需要消失确认期（5秒）才清除状态
     - 如果未确认：直接清除首次检测时间

### 时间线示例

```
时间轴：
T0: 首次检测到图标
    ├─ 记录 firstDetectedTime = T0
    ├─ 发送通知（如果不在冷却期）✓
    └─ 不更新时间 ✗

T0+1秒: 持续检测中
    └─ 等待确认...

T0+2秒: 达到确认期
    ├─ 确认空投出现
    ├─ 更新时间（使用 T0）✓
    └─ 不再次发送通知 ✗

T0+60秒: 玩家使用传送门，地图切换
    ├─ Vignette API 可能短暂返回空列表
    ├─ 记录 disappearedTime = T0+60
    └─ 保持 mapIconDetected = true（等待确认）

T0+61秒: Vignette 重新出现
    └─ 清除 disappearedTime，保持 mapIconDetected = true ✓

或者：

T0+60秒: 玩家使用传送门，地图切换
    ├─ Vignette API 短暂返回空列表
    ├─ 记录 disappearedTime = T0+60
    └─ 保持状态

T0+65秒: 持续消失超过5秒
    └─ 清除所有状态 ✓
```

## 优势

1. **解决子地图/父地图切换问题**：
   - 使用 `targetMapData.id` 作为状态键，子地图和父地图共享同一状态
   - 消失确认期防止因API延迟导致的误清除

2. **防止重复通知**：
   - 冷却期机制避免短时间内重复通知
   - 首次检测立即通知，2秒确认后不再次通知

3. **保持检测准确性**：
   - 空投真正结束后仍会正确清除状态
   - 时间更新仍然需要2秒确认，避免误判

4. **提高用户体验**：
   - 第一时间通知用户空投出现
   - 避免重复通知干扰

## 测试建议

1. **子地图/父地图切换测试**：
   - 在子地图（塔扎维什）检测到空投
   - 使用传送门切换到主地图（卡雷什）
   - 验证：只发送一次通知，只更新一次时间

2. **传送门穿梭测试**：
   - 在空投持续期间，多次使用传送门在子地图和主地图之间穿梭
   - 验证：不会重复发送通知和更新时间

3. **冷却期测试**：
   - 在2分钟内，同一地图检测到多个空投
   - 验证：只发送第一次通知，后续在冷却期内不发送

4. **消失确认测试**：
   - 检测到空投后，图标短暂消失（<5秒）然后重新出现
   - 验证：状态保持，不重新检测

---

*修复日期：2024年*

