# 通知功能优化说明

## 优化内容

### 1. 自动检测到空投时的通知（NotifyAirdropDetected）

**优化前**：
- 只发送 RAID_WARNING（仅在团队中）
- 如果不在团队中，只发送到聊天框

**优化后**：
- 始终发送到聊天框
- 如果启用了团队通知（`teamNotificationEnabled = true`）**且在团队中**：
  - 发送普通团队消息（RAID）
  - 发送团队通知（RAID_WARNING）
- **小队中不发送自动消息**

**消息发送逻辑**：
```
自动检测到空投：
├─ 聊天框：始终发送 ✓
├─ 如果 teamNotificationEnabled = true 且在团队中：
│  ├─ RAID（普通团队消息）✓
│  └─ RAID_WARNING（团队通知）✓
├─ 如果 teamNotificationEnabled = true 但不在团队中（包括小队）：
│  └─ 只发送到聊天框，不发送任何团队/队伍消息 ✓
└─ 如果 teamNotificationEnabled = false：
   └─ 只发送到聊天框 ✓
```

### 2. 手动通知（NotifyMapRefresh）

**优化前**：
- 根据队伍类型发送消息，但受 `teamNotificationEnabled` 控制

**优化后**：
- **不受 `teamNotificationEnabled` 控制**
- 在队伍中（团队或小队）：发送到队伍（PARTY/RAID/INSTANCE_CHAT）
- 不在队伍中：发送到聊天框（个人消息）

**消息发送逻辑**：
```
手动通知（点击通知按钮）：
├─ 在队伍中：
│  └─ 发送到队伍（PARTY/RAID/INSTANCE_CHAT）✓
└─ 不在队伍中：
   └─ 发送到聊天框（个人消息）✓
   
注意：不受 /ctk team on/off 控制
```

### 3. 命令控制

**命令**：
- `/ctk team on` - 开启自动团队通知
- `/ctk team off` - 关闭自动团队通知

**控制范围**：
- ✅ 自动检测通知的普通团队消息（RAID）
- ✅ 自动检测通知的团队通知（RAID_WARNING）
- ❌ 手动通知不受控制（始终根据队伍状态发送）

## 代码修改

### 修改文件
- `Modules/Notification.lua`

### 主要变更

1. **NotifyAirdropDetected 函数**：
   - 添加普通团队/队伍消息发送
   - 保留 RAID_WARNING 发送（仅在团队中）
   - 两条消息都受 `teamNotificationEnabled` 控制

2. **NotifyMapRefresh 函数**：
   - 添加 `teamNotificationEnabled` 检查
   - 如果启用且在队伍中，发送到队伍
   - 否则发送到聊天框

## 使用场景示例

### 场景1：自动检测到空投（在团队中，通知已启用）
- 聊天框：显示消息 ✓
- 团队聊天（RAID）：显示消息 ✓
- 团队通知（RAID_WARNING）：显示消息 ✓

### 场景2：自动检测到空投（在队伍中，通知已启用）
- 聊天框：显示消息 ✓
- 队伍聊天（PARTY）：显示消息 ✓
- 团队通知：不发送（不在团队中）

### 场景3：自动检测到空投（不在队伍中，通知已启用）
- 聊天框：显示消息 ✓
- 其他：不发送

### 场景4：自动检测到空投（通知已关闭）
- 聊天框：显示消息 ✓
- 其他：不发送

### 场景5：手动通知（在队伍中，通知已启用）
- 队伍聊天（PARTY/RAID/INSTANCE_CHAT）：显示消息 ✓
- 聊天框：不显示（已发送到队伍）

### 场景6：手动通知（不在队伍中，通知已启用）
- 聊天框：显示消息 ✓

### 场景7：手动通知（通知已关闭）
- 聊天框：显示消息 ✓

## 优势

1. **提高通知可靠性**：
   - 即使没有 RAID_WARNING 权限，也能通过普通团队消息通知
   - 两条消息确保重要信息不会遗漏

2. **灵活控制**：
   - 一个命令控制所有团队/队伍消息
   - 个人消息（聊天框）始终可用

3. **符合用户习惯**：
   - 在队伍中时发送队伍消息
   - 不在队伍中时发送个人消息
   - 自动检测时双重保障

---

*优化日期：2024年*

