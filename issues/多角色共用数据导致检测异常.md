# 多角色共用数据导致检测异常

## 问题描述

**日期**: 2024-12-19  
**版本**: 1.1.3  
**严重程度**: 高  
**状态**: ✅ 已修复

### 症状

使用另一个角色时，空投检测功能不正常，无法正确检测空投。只有重置数据后功能才恢复正常。

### 复现步骤

1. 使用角色A在某个地图（如多恩岛）检测到空投
2. 空投检测后进入 `PROCESSED` 状态（暂停检测5分钟）
3. 切换角色B，进入相同地图
4. 角色B无法检测空投，即使地图上有空投图标

## 问题分析

### 根本原因

插件使用全局 `SavedVariables` 存储刷新时间数据（这是合理的，所有角色共享刷新时间），但**内存中的检测状态在角色切换时没有被清除**，导致新角色继承了旧角色的检测状态。

### 问题代码位置

1. **DetectionState 模块** (`Modules/DetectionState.lua`)
   - `processedTime[mapId]` - 存储地图的处理状态（暂停检测5分钟）
   - `mapIconFirstDetectedTime[mapId]` - 首次检测时间
   - `mapIconDetected[mapId]` - 检测状态标记
   - `lastUpdateTime[mapId]` - 最后更新时间

2. **MapTracker 模块** (`Modules/MapTracker.lua`)
   - `lastDetectedMapId` - 上次检测到的配置地图ID
   - `lastDetectedGameMapID` - 上次检测到的游戏地图ID
   - `mapLeftTime[mapId]` - 离开地图时间记录

3. **NotificationCooldown 模块** (`Modules/NotificationCooldown.lua`)
   - `lastNotificationTime[mapId]` - 通知冷却记录

4. **Phase 模块** (`Modules/Phase.lua`)
   - `anyInstanceIDAcquired` - 位面获取状态
   - `lastReportedInstanceID` - 最后报告的位面ID

5. **Core 模块** (`Core/Core.lua`)
   - `OnLogin()` 函数在角色登录时没有重置这些内存状态

### 问题流程

```
角色A登录
  ↓
检测到空投 → 进入 PROCESSED 状态（暂停5分钟）
  ↓
切换角色B登录
  ↓
OnLogin() 执行，但只初始化模块，不清除状态
  ↓
DetectionState 仍然保留角色A的 PROCESSED 状态
  ↓
角色B无法检测（被 PROCESSED 状态阻止）
```

## 解决方案

### 修复内容

#### 1. DetectionState.lua - 添加清除所有状态的方法

```lua
function DetectionState:ClearAllStates()
    self:Initialize();
    
    -- 清除所有地图的检测状态
    self.mapIconFirstDetectedTime = {};
    self.mapIconDetected = {};
    self.lastUpdateTime = {};
    self.processedTime = {};
    
    Logger:Debug("DetectionState", "重置", "已清除所有地图的检测状态");
end
```

#### 2. MapTracker.lua - 完全重置状态

修改 `Initialize()` 方法，确保完全重置所有状态（不再使用 `or {}` 保留旧数据）：

```lua
function MapTracker:Initialize()
    -- 完全重置所有状态
    self.mapLeftTime = {};
    self.lastDetectedMapId = nil;
    self.lastDetectedGameMapID = nil;
    self.MAP_LEFT_CLEAR_TIME = 300;
    self.lastMatchedMapID = nil;
    self.lastUnmatchedMapID = nil;
end
```

#### 3. NotificationCooldown.lua - 添加清除方法

```lua
function NotificationCooldown:ClearAll()
    self:Initialize();
    self.lastNotificationTime = {};
    Logger:Debug("NotificationCooldown", "重置", "已清除所有通知冷却记录");
end
```

#### 4. Phase.lua - 添加重置方法

```lua
function Phase:Reset()
    self.anyInstanceIDAcquired = false;
    self.lastReportedInstanceID = nil;
    Logger:Debug("Phase", "重置", "已重置位面检测状态");
end
```

#### 5. Core.lua - 在登录时重置所有状态

在 `OnLogin()` 函数中添加重置逻辑：

```lua
local function OnLogin()
    -- ... 其他初始化代码 ...
    
    -- 【修复】角色切换时重置所有内存中的检测状态
    -- 这些状态不应该跨角色共享，必须在每次登录时清除
    if DetectionState and DetectionState.ClearAllStates then
        DetectionState:ClearAllStates();
    end
    
    if MapTracker then
        MapTracker:Initialize();
        Logger:Debug("Core", "重置", "已重置地图追踪器状态");
    end
    
    if NotificationCooldown and NotificationCooldown.ClearAll then
        NotificationCooldown:ClearAll();
    end
    
    if Phase and Phase.Reset then
        Phase:Reset();
    end
    
    -- 重置 Area 模块状态
    if Area then
        Area.lastAreaValidState = nil;
        Area.detectionPaused = false;
    end
    
    -- 重置核心模块的定时器状态
    if CrateTrackerZK.phaseTimerTicker then
        CrateTrackerZK.phaseTimerTicker:Cancel();
        CrateTrackerZK.phaseTimerTicker = nil;
    end
    CrateTrackerZK.phaseTimerPaused = false;
    CrateTrackerZK.phaseResumePending = false;
    
    -- ... 其他初始化代码 ...
end
```

### 修复后的流程

```
角色A登录
  ↓
检测到空投 → 进入 PROCESSED 状态
  ↓
切换角色B登录
  ↓
OnLogin() 执行
  ↓
清除所有内存状态（DetectionState、MapTracker 等）
  ↓
重新初始化检测系统
  ↓
角色B可以正常检测空投 ✅
```

## 技术细节

### 数据存储策略

- **全局数据（SavedVariables）**: 
  - `CRATETRACKERZK_DB` - 存储刷新时间、位面信息等（所有角色共享）
  - `CRATETRACKERZK_UI_DB` - 存储UI设置（所有角色共享）
  - ✅ **保留**：这些数据应该跨角色共享

- **内存状态（模块变量）**:
  - `DetectionState` 的检测状态
  - `MapTracker` 的地图追踪状态
  - `NotificationCooldown` 的通知记录
  - `Phase` 的位面检测状态
  - ✅ **清除**：这些状态不应该跨角色共享

### 为什么需要这样设计

1. **刷新时间数据应该共享**：所有角色在同一个服务器上，空投刷新时间是全局的
2. **检测状态不应该共享**：每个角色的检测状态是独立的，不应该互相影响
3. **角色切换时需要重置**：确保每个角色都有干净的检测环境

## 测试验证

### 测试步骤

1. ✅ 使用角色A在某个地图检测到空投（进入 PROCESSED 状态）
2. ✅ 切换角色B，进入相同地图
3. ✅ 验证角色B可以正常检测空投（不再被 PROCESSED 状态阻止）
4. ✅ 验证刷新时间数据仍然保留（因为使用全局 SavedVariables）

### 预期结果

- ✅ 每个角色都有独立的检测状态
- ✅ 刷新时间数据在所有角色间共享
- ✅ 切换角色后检测功能正常工作

## 相关文件

- `Core/Core.lua` - 核心初始化逻辑
- `Modules/DetectionState.lua` - 检测状态管理
- `Modules/MapTracker.lua` - 地图追踪管理
- `Modules/NotificationCooldown.lua` - 通知冷却管理
- `Modules/Phase.lua` - 位面检测管理
- `Modules/Area.lua` - 区域检测管理

## 总结

这个问题是由于内存中的检测状态在角色切换时没有被清除导致的。修复方案是在每次 `PLAYER_LOGIN` 事件时，清除所有内存中的检测状态，同时保留全局的刷新时间数据。这样既保证了刷新时间数据的共享，又确保了每个角色都有独立的检测环境。

---

**修复提交**: 2024-12-19  
**修复版本**: 1.1.3+  
**修复者**: AI Assistant (Auto)

