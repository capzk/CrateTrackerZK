# 变更日志

## [未发布] - 重复检测修复与状态管理优化

### 优化
- **重复检测问题修复**
  - **首次检测立即通知，2秒确认后更新时间**：
    - 首次检测到空投图标时立即发送通知（检查冷却期）
    - 不立即更新时间，等待2秒持续检测确认
    - 2秒确认后更新时间，不再次发送通知
    - 提高响应速度，避免重复通知
  - **通知冷却期机制**：
    - 同一地图在120秒（2分钟）内不重复发送通知
    - 冷却期仅在首次检测时检查
    - 时间更新不受冷却期影响
  - **消失确认期机制**：
    - 已确认的空投需要持续消失5秒才清除状态
    - 防止因地图切换或API延迟导致的误清除
    - 如果图标在确认期内重新出现，保持状态
  - **离开地图状态自动清除**：
    - 当玩家离开某个地图后，如果5分钟内没有回到该地图，自动清除该地图的检测状态
    - 避免长期占用内存，保持状态准确性
    - 文件：`Modules/Timer.lua`

### 修复
- **数据清除逻辑完善**
  - 修复 `Data:ClearAllData()` 未清除新增状态字段的问题
  - 修复 `Commands:HandleClearCommand()` 未清除新增状态字段的问题
  - 确保 `/ctk clear` 命令能完整清除所有状态
  - 文件：`Data/Data.lua`, `Modules/Commands.lua`

### 设计说明
- **检测流程优化**：
  - 首次检测立即通知，提升用户体验
  - 2秒确认机制确保检测准确性
  - 通知冷却期防止重复通知
  - 消失确认期防止误清除
  - 离开地图状态自动清除保持内存效率

### 文档更新
- 更新 `RUNTIME_LOGIC.md`：添加新的检测机制说明
- 更新 `FUNCTIONALITY_AND_LOGIC.md`：更新持续检测确认机制
- 更新 `DATA_FLOW.md`：更新数据流说明
- 更新 `MODULE_ARCHITECTURE.md`：更新Timer模块说明
- 创建 `issues/DUPLICATE_DETECTION_FIX.md`：记录重复检测问题修复
- 创建 `issues/MAP_LEFT_STATE_OPTIMIZATION.md`：记录离开地图状态优化
- 创建 `issues/COMPREHENSIVE_CHECK.md`：记录完整检查结果

---

## [未发布] - 通知功能优化与子地图检测修复

### 优化
- **通知功能优化**
  - **自动检测通知**：
    - 在团队中：发送两条消息（RAID 普通消息 + RAID_WARNING 团队通知）
    - 在小队中：不发送自动消息（只发送到聊天框）
    - 受 `/ctk team on/off` 命令控制
  - **手动通知**：
    - 不受 `/ctk team on/off` 命令控制
    - 在队伍中：发送到队伍（PARTY/RAID/INSTANCE_CHAT）
    - 不在队伍中：发送到聊天框
  - 文件：`Modules/Notification.lua`

### 修复
- **修复子地图空投检测失败问题**
  - 问题：在子地图（如塔扎维什 2472，父地图为卡雷什 2371）上无法检测到空投
  - 原因：代码使用 `GetVignettePosition` 检查位置，但子地图ID可能无法获取父地图Vignette的位置信息
  - 修复：移除位置检查的强制要求，检测逻辑仅依赖名称匹配
  - 影响：提高了检测可靠性，支持所有子地图场景
  - 文件：`Modules/Timer.lua`

### 设计说明
- **检测逻辑优化**：检测仅依赖名称匹配，不依赖位置信息
  - `GetVignettes()` 已返回当前地图上的所有Vignette，无需位置验证
  - 区域有效性检测已确保在正确的追踪区域
  - 简化了代码逻辑，提高了可靠性
  - 支持所有子地图场景（子地图上的Vignette可能无法用子地图ID获取位置）

### 文档更新
- 更新 `FUNCTIONALITY_AND_LOGIC.md`：添加检测原理的设计说明，更新通知系统说明
- 更新 `RUNTIME_LOGIC.md`：明确检测流程不依赖位置信息，更新通知渠道说明
- 更新 `DATA_FLOW.md`：更新自动和手动通知的数据流
- 更新 `MODULE_ARCHITECTURE.md`：更新通知模块说明
- 更新 `FUNCTIONALITY_OVERVIEW.md`：更新团队通知功能说明
- 更新 `issues/NOTIFICATION_OPTIMIZATION.md`：记录通知功能优化详情

---

*变更日期：2024年*

