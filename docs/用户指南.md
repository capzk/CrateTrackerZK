# CrateTrackerZK 用户指南

## 目录

1. [插件简介](#插件简介)
2. [快速开始](#快速开始)
3. [核心功能](#核心功能)
4. [用户命令](#用户命令)
5. [用户界面](#用户界面)
6. [团队通知](#团队通知)
7. [空投检测宏](#空投检测宏)
8. [数据存储](#数据存储)

---

## 插件简介

CrateTrackerZK 是一个魔兽世界插件，用于自动追踪和记录游戏中的战争物资空投宝箱（War Supply Crate）的刷新时间和位面信息。

**版本**: 1.1.4.20251229_beta  
**作者**: capzk  
**项目地址**: https://github.com/capzk/CrateTrackerZK

---

## 快速开始

### 1. 输入刷新时间
点击表格中的"上次刷新"列，输入时间（格式：`HH:MM:SS` 或 `HHMMSS`）

### 2. 查看倒计时
主面板实时显示各地图的下次刷新倒计时

### 3. 获取位面 ID
将鼠标指向任意 NPC 即可获取当前位面 ID

---

## 核心功能

### 1. 自动空投检测

- **检测原理**：通过地图图标（Vignette）系统自动检测空投箱子的出现
- **检测频率**：每1秒扫描一次当前地图上的所有Vignette图标
- **名称匹配**：通过图标名称匹配空投箱子（"战争物资箱" / "War Supply Crate"）
- **持续确认**：检测到图标后需要持续2秒才确认，防止误判
- **自动记录**：确认后自动记录刷新时间并计算下次刷新时间

**设计说明**：
- 检测**仅依赖名称匹配**，不依赖位置信息
- 支持子地图检测（如塔扎维什作为卡雷什的子地图）
- 区域有效性检测已确保在正确的追踪区域

### 2. 刷新时间追踪

- **自动计算**：自动计算下次刷新时间（默认间隔1100秒，约18.3分钟）
- **实时显示**：实时显示倒计时
- **手动输入**：支持手动输入刷新时间
- **数据持久化**：数据持久化保存（SavedVariables），重载/重登不丢失

**时间计算逻辑**：
```
nextRefresh = lastRefresh + n * interval

其中：
- lastRefresh: 上次刷新时间戳
- interval: 刷新间隔（默认1100秒）
- n: 计算出的刷新次数
```

**时间更新触发**：
- **自动检测**：地图图标检测确认空投出现
- **手动输入**：用户点击"上次刷新"列输入时间
- **刷新按钮**：用户点击"刷新"按钮使用当前时间

### 3. 位面（Phase）追踪

- **自动检测**：自动检测当前位面ID
- **获取方式**：通过鼠标指向NPC获取位面信息
- **系统消息提醒**：
  - 首次获取到位面ID时发送系统消息："【地图名】当前位面ID：|cffffff00XX|r"
  - 位面发生变化时发送系统消息："【地图名】当前位面ID已变更为：|cffffff00XX|r"
- **颜色标识**：
  - **绿色**：当前检测到空投，或位面匹配
  - **红色**：位面不匹配（与上次刷新时的位面不同）
  - **白色**：无位面信息或已过期

**位面检测原理**：
```
GUID格式: "Creature-0-[分片ID]-[实例ID]-[zoneUID]-[NPC ID]-[spawnUID]"
位面ID = 分片ID + "-" + 实例ID (第3部分-第4部分)
```

**检测触发时机**：
- 区域变化时
- 目标改变时
- 鼠标悬停在NPC上时（工具提示显示时）

### 4. 多地图支持

当前支持追踪的地图：
- 多恩岛 (MapID: 2248)
- 海妖岛 (MapID: 2369)
- 卡雷什 (MapID: 2371)
- 安德麦 (MapID: 2346)
- 陨圣峪 (MapID: 2215)
- 喧鸣深窟 (MapID: 2214)
- 艾基-卡赫特 (MapID: 2255)

所有地图使用相同刷新间隔：1100秒

### 5. 多语言支持

- **支持语言**：简体中文 (zhCN)、繁体中文 (zhTW)、英文 (enUS)、俄文 (ruRU)
- **自动切换**：自动根据客户端语言切换
- **回退机制**：英文作为回退语言

---

## 用户命令

### 基本命令

- `/ctk` 或 `/ct` - 打开/关闭主面板
- `/ctk help` - 显示帮助信息
- `/ctk clear` - 清除所有数据并重新初始化

### 设置命令

- `/ctk team on/off` - 开启/关闭团队通知
  - `on`: 启用团队通知（在团队中自动发送空投消息）
  - `off`: 禁用团队通知（只发送到聊天框）
- `/ctk debug on/off` - 开启/关闭调试模式
  - `on`: 启用调试模式（显示详细日志）
  - `off`: 禁用调试模式（只显示重要信息）

---

## 用户界面

### 主面板

主面板显示5列信息：

1. **地图名称** - 本地化的地图名称
2. **位面ID** - 当前位面（后5位），带颜色标识
3. **上次刷新** - 可点击编辑，格式：HH:MM:SS
4. **下次刷新** - 倒计时显示，可排序，带颜色标识
5. **操作** - 刷新按钮、通知按钮

### 交互功能

- **点击"上次刷新"列**：弹出输入框，可手动输入时间
- **点击"刷新"按钮**：使用当前时间更新刷新时间
- **点击"通知"按钮**：发送当前地图的刷新信息到团队
- **点击表头排序**：按"上次刷新"或"下次刷新"排序
- **拖拽窗口**：移动主面板位置，自动保存

### 浮动按钮

- 快速打开/关闭主面板
- 可拖拽
- 位置自动保存

### 颜色标识规则

**位面ID颜色**：
- **绿色**：当前检测到空投或位面匹配
- **红色**：位面不匹配（与上次刷新时的位面不同）
- **白色**：无位面信息或已过期

**倒计时颜色**：
- **红色**：< 5分钟
- **橙色**：< 15分钟
- **绿色**：>= 15分钟

---

## 团队通知

### 自动检测通知

**触发时机**：插件自动检测到空投时

**控制方式**：受 `/ctk team on/off` 命令控制

**发送渠道**：
- **聊天框**：始终发送
- **团队消息**（仅在团队中，且 `teamNotificationEnabled = true`）：
  - RAID（普通团队消息）
  - RAID_WARNING（团队通知）
- **小队中**：不发送自动消息

**消息格式**：
- 中文：`【地图名称】 检测到战争物资正在空投！！！`
- 英文：`[Map Name] Detected War Supplies airdrop!!!`

### 手动通知

**触发时机**：用户点击"通知"按钮

**控制方式**：不受 `/ctk team on/off` 命令控制

**发送渠道**：
- **在队伍中**：发送到队伍（PARTY/RAID/INSTANCE_CHAT）
- **不在队伍中**：发送到聊天框

**消息格式**：
- 如果空投活跃：`【地图名称】 战争物资正在空投！！！`
- 否则：`【地图名称】 剩余时间: MM:SS`

### 消息格式区分

**自动检测消息**（带"检测到"关键字）：
- 会被 `TeamMessageReader` 识别并记录
- 用于防止重复通知（30秒冷却期）

**手动通知消息**（不带"检测到"关键字）：
- 不会被 `TeamMessageReader` 识别
- 用于用户主动发送的通知

### 无效空投系统消息

当检测到无效空投事件时（图标在2秒确认期内消失，或2秒确认后图标消失/SpawnUID变化），插件会发送系统消息提醒：

**消息格式**：`【地图名】 检测到无效空投事件，空投飞机存在时间过短，判定为无效事件。`

**说明**：
- 只发送系统消息（聊天框），不发送团队通知
- 用于提醒用户检测到无效的空投事件
- 帮助用户了解为什么某些空投事件没有被记录

---

## 空投检测宏

### 检测当前地图的空投箱子

**推荐版本（已验证可用）**：

```lua
/run local v=C_VignetteInfo.GetVignettes();local c=0;for _,g in ipairs(v)do local n=C_VignetteInfo.GetVignetteInfo(g).name;if n=="战争物资箱"or n=="War Supply Crate"then c=c+1 end end;print(c>0 and"发现"..c.."个空投"or"未发现空投")
```

### 使用方法

1. 在游戏中按 `ESC` → `宏命令设置`
2. 点击 `新建`，输入宏名称（如：`检测空投`）
3. **完整复制**上面的代码（包括 `/run`），粘贴到宏命令框中
4. 点击 `确定`，将宏拖到动作条上
5. 点击宏按钮执行

**注意**：复制时确保代码完整，不要有换行或截断。

---

## 数据存储

### SavedVariables

插件使用两个 SavedVariables：

**CRATETRACKERZK_DB** - 存储地图数据：
- 刷新时间（`lastRefresh`）
- 创建时间（`createTime`）
- 空投事件信息（`currentAirdropObjectGUID`：完整的 objectGUID，用于去重和位面信息提取；`currentAirdropTimestamp`）
- 注意：位面信息不存储，在UI层从 `currentAirdropObjectGUID` 实时提取

**CRATETRACKERZK_UI_DB** - 存储UI设置：
- 窗口位置（`position`）
- 浮动按钮位置（`minimapButton.position`）
- 调试模式开关（`debugEnabled`）
- 团队通知开关（`teamNotificationEnabled`）

### 数据持久化

- **保存时机**：
  - 刷新时间更新时
  - 位面信息更新时
  - UI位置变化时
  - 设置变更时
- **加载时机**：插件初始化时自动加载
- **数据共享**：所有角色共享刷新时间和位面数据

---

## 技术特性

- **区域有效性检测**：自动暂停在副本/战场
- **智能地图匹配**：支持父地图匹配
- **防误触机制**：
  - 2秒持续检测确认
  - 3分钟冷却期（防止重复检测）
  - 重新检测验证（双重验证）
- **调试模式支持**：限流优化，避免刷屏
- **模块化架构设计**：代码结构清晰，易于维护

---

**最后更新**：2024-12-29  
**维护者**：capzk

