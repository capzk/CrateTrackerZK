# CrateTrackerZK 技术文档

## 目录

1. [模块架构](#模块架构)
2. [运行逻辑](#运行逻辑)
3. [数据流](#数据流)
4. [API参考](#api参考)

---

## 模块架构

### 整体架构

CrateTrackerZK 采用模块化设计，各模块职责清晰，通过 `BuildEnv` 系统进行模块间通信。

```
┌─────────────────────────────────────────────────────────┐
│                    核心层 (Core)                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Core.lua - 事件处理、初始化协调                      │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
┌───────▼──────┐  ┌───────▼──────┐  ┌───────▼──────┐
│   数据层     │  │   功能层     │  │    UI层      │
│  (Data)      │  │  (Modules)   │  │   (UI)       │
└──────────────┘  └──────────────┘  └──────────────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          │
                ┌─────────▼─────────┐
                │   工具层 (Utils)   │
                └────────────────────┘
```

### 核心层 (Core)

#### Core.lua
**职责**: 
- 插件生命周期管理
- 事件注册和处理
- 模块初始化协调
- 全局功能控制（暂停/恢复检测）

**主要函数**:
- `OnLogin()`: 玩家登录时的初始化流程
- `OnEvent()`: 游戏事件处理
- `PauseAllDetections()`: 暂停所有检测
- `ResumeAllDetections()`: 恢复所有检测
- `Reinitialize()`: 重新初始化插件

### 数据层 (Data)

#### Data/Data.lua
**职责**:
- 地图数据管理
- 刷新时间计算
- 数据持久化（SavedVariables）
- 时间格式化

**核心数据结构**:
```lua
Data.maps = {
  [id] = {
    id = 1,                    -- 内部ID
    mapID = 2248,             -- 游戏地图ID
    interval = 1100,          -- 刷新间隔（秒）
    lastRefresh = timestamp,  -- 上次刷新时间戳
    nextRefresh = timestamp,  -- 下次刷新时间戳
    createTime = timestamp,   -- 创建时间
    currentAirdropObjectGUID = "Creature-0-3903-2601-46834-135181-00005467A0",  -- 当前空投事件的完整 objectGUID
    currentAirdropTimestamp = timestamp,  -- 当前空投事件的时间戳
    currentPhaseID = "123-456"  -- 实时检测到的位面ID（不持久化，仅用于UI显示比较）
    -- 注意：位面信息不存储，在UI层从 currentAirdropObjectGUID 实时提取
  }
}
```

#### Data/MapConfig.lua
**职责**:
- 地图配置管理
- 空投箱子配置
- 配置验证

### 功能模块层 (Modules)

#### Modules/Timer.lua (TimerManager)
**职责**:
- 定时器管理
- 检测循环协调
- 刷新时间更新触发
- 状态汇总输出

**检测流程**:
1. 每1秒执行一次检测循环
2. 获取当前地图ID
3. 通过 MapTracker 匹配目标地图数据
4. 通过 IconDetector 检测图标（返回 objectGUID 和 SpawnUID）
5. 通过 SpawnUID 比对识别同一空投事件
6. 2秒确认机制防止误报
7. 30秒通知限制防止过期通知

#### Modules/IconDetector.lua
**职责**:
- 图标检测（仅负责检测逻辑）
- 仅依赖名称匹配

**检测方法**:
- 使用 `C_VignetteInfo.GetVignettes()` 获取所有图标
- 通过名称匹配查找空投箱子

#### Modules/MapTracker.lua
**职责**:
- 地图匹配（支持父地图匹配）
- 地图变化检测

#### Modules/Timer.lua (检测状态管理)
**职责**:
- 检测状态管理（简化的2秒确认机制）
- SpawnUID 比对去重

**检测状态**:
- 首次检测：记录 `firstDetectedTime` 和 `spawnUID`
- 2秒确认：持续检测2秒后确认空投事件
- SpawnUID比对：通过比对 SpawnUID 识别同一空投事件

#### Modules/Phase.lua
**职责**:
- 位面（Phase）检测
- 位面信息更新
- 位面变化通知

**检测方法**:
- 从NPC的GUID中提取位面信息
- GUID格式: `Creature-0-[分片ID]-[实例ID]-[zoneUID]-[NPC ID]-[spawnUID]`
- 位面ID = `分片ID-实例ID` (第3部分-第4部分)

#### Modules/Area.lua
**职责**:
- 区域有效性检测
- 检测暂停/恢复控制

**有效性判断**:
- 无效: 副本、战场、竞技场、场景战役
- 有效: 不是副本/战场且地图在追踪列表中
- 注意: 室内区域不再被视为无效区域

#### Modules/Notification.lua
**职责**:
- 通知消息发送
- 团队通知管理

**通知类型**:
- 自动检测通知: 检测到空投时（受 `/ctk team on/off` 控制）
- 手动通知: 用户点击通知按钮（不受 `/ctk team on/off` 控制）

#### Modules/TeamMessageReader.lua
**职责**:
- 团队消息读取
- 自动更新刷新时间
- 防止重复更新

#### Modules/Commands.lua
**职责**:
- 斜杠命令处理
- 命令解析和执行

### UI层 (UI)

#### UI/MainPanel.lua
**职责**:
- 主面板创建和管理
- 表格显示和更新
- 用户交互处理

**更新频率**: 每1秒自动更新

#### UI/FloatingButton.lua
**职责**:
- 浮动按钮创建和管理
- 快速打开/关闭主面板

### 工具层 (Utils)

#### Utils/Logger.lua
**职责**:
- 统一日志输出系统
- 日志级别管理（ERROR, WARN, INFO, DEBUG, SUCCESS）
- 消息限流（支持不同类型消息的限流间隔）

#### Utils/Localization.lua
**职责**:
- 本地化管理
- 翻译完整性验证
- 回退机制

**支持语言**:
- zhCN（简体中文）
- zhTW（繁体中文）
- enUS（英文，回退语言）
- ruRU（俄文）

### 模块间通信

#### BuildEnv 系统

所有模块通过 `BuildEnv(name)` 函数创建和访问：

```lua
local ModuleName = BuildEnv("ModuleName")
```

**特点**:
- 延迟加载：模块在首次访问时创建
- 全局访问：所有模块都可以访问其他模块
- 命名空间隔离：避免全局变量污染

---

## 运行逻辑

### 插件初始化流程

#### 文件加载顺序

根据 `Load.xml`，插件按以下顺序加载：

```
1. 基础工具
   ├─ Utils/Utils.lua
   └─ Utils/Logger.lua

2. 本地化系统
   ├─ Utils/Localization.lua
   ├─ Locales/Locales.lua
   └─ Locales/*.lua (zhCN, zhTW, ruRU, enUS)

3. 数据管理
   ├─ Data/MapConfig.lua
   └─ Data/Data.lua

4. 功能模块（按依赖顺序）
   ├─ Modules/Notification.lua
   ├─ Modules/TeamMessageReader.lua
   ├─ Modules/Commands.lua
   ├─ Modules/IconDetector.lua
   ├─ Modules/MapTracker.lua
   ├─ Modules/Timer.lua
   ├─ Modules/Area.lua
   └─ Modules/Phase.lua

5. UI模块
   ├─ UI/Info.lua
   ├─ Core/Core.lua
   ├─ UI/FloatingButton.lua
   └─ UI/MainPanel.lua
```

#### 初始化步骤

当玩家登录时，触发 `PLAYER_LOGIN` 事件：

```
1. 初始化 SavedVariables
   ├─ CRATETRACKERZK_UI_DB (UI设置)
   └─ CRATETRACKERZK_DB (地图数据)

2. 清除所有内存检测状态（防止跨角色污染）
   ├─ TimerManager.detectionState = {}（清除2秒确认期的临时状态）
   ├─ MapTracker:Initialize()（重置地图追踪状态）
   ├─ Phase:Reset()（重置位面检测状态）
   ├─ Area.lastAreaValidState = nil, Area.detectionPaused = false（区域状态重置）
   ├─ 所有地图数据的 currentPhaseID = nil（清除实时检测到的位面ID）
   ├─ CrateTrackerZK.phaseTimerPaused = false, phaseResumePending = false（定时器状态重置）
   ├─ MainPanel.lastNotifyClickTime = {}（清除通知按钮点击时间）
   └─ Logger:ClearMessageCache()（清除日志缓存）

3. 初始化各模块
   ├─ Localization:Initialize()
   ├─ Data:Initialize()
   ├─ Notification:Initialize()
   └─ Commands:Initialize()

4. 启动检测系统
   ├─ TimerManager:Initialize()
   └─ TimerManager:StartMapIconDetection(1) // 每1秒检测

5. 创建UI界面
   ├─ MainPanel:CreateMainFrame()
   └─ CrateTrackerZK:CreateFloatingButton()

6. 检查区域有效性
   └─ Area:CheckAndUpdateAreaValid()
```

### 核心运行循环

#### 地图图标检测循环

```
每1秒执行：
├─ TimerManager:DetectMapIcons()
│  ├─ 获取当前地图ID
│  ├─ MapTracker:GetTargetMapData() - 匹配目标地图数据
│  ├─ MapTracker:OnMapChanged() - 处理地图变化
│  ├─ IconDetector:DetectIcon() - 检测图标（返回 objectGUID 和 SpawnUID）
│  ├─ SpawnUID 比对 - 检查是否是已知事件
│  ├─ 2秒确认机制 - 防止短暂图标闪烁误报
│  ├─ 30秒通知限制 - 检查是否允许发送通知
│  └─ 如果确认：
│      ├─ 发送通知（如果需要）
│      ├─ 更新刷新时间
│      ├─ 更新 currentAirdropSpawnUID 和 currentAirdropTimestamp
│      └─ 更新UI显示
│
└─ 条件检查：
   ├─ 区域必须有效
   ├─ 检测未暂停
   └─ 地图在追踪列表中
```

#### UI更新循环

```
每1秒执行：
├─ MainPanel:UpdateTable()
│  ├─ 更新所有地图的刷新时间
│  ├─ 计算剩余时间
│  ├─ 应用排序（如果启用）
│  └─ 更新表格显示
│
└─ 颜色更新：
   ├─ 位面ID颜色
   └─ 倒计时颜色
```

#### 位面检测触发

```
事件触发：
├─ ZONE_CHANGED / ZONE_CHANGED_NEW_AREA
│  └─ 延迟0.1秒后执行
│     ├─ 检查区域有效性
│     └─ 更新位面信息（延迟6秒）
│
├─ PLAYER_TARGET_CHANGED
│  └─ 立即更新位面信息
│
└─ Tooltip显示（鼠标悬停NPC）
   └─ 立即更新位面信息
```

### 检测机制

#### SpawnUID 去重机制

**目的**：识别同一空投事件，防止重复检测和通知

**原理**：
- SpawnUID 是 GUID 的第7部分，每次空投事件生成时都是随机的
- 同一空投事件的 SpawnUID 在整个事件生命周期内保持不变
- 通过比对 SpawnUID 可以识别是否是同一个空投事件

**比对逻辑**：
1. 检测到图标时，提取 SpawnUID
2. 与 `mapData.currentAirdropSpawnUID` 比对
3. 如果相同，跳过处理（同一事件）
4. 如果不同或不存在，视为新事件，开始检测流程

#### 防误触机制

- **2秒确认期**：首次检测到图标后，需要持续检测2秒才确认
- **SpawnUID比对**：通过比对 SpawnUID 识别同一空投事件，防止重复检测
- **30秒通知限制**：空投开始后30秒内才允许发送通知（基于 `currentAirdropTimestamp`）
- **重新检测验证**：在2秒确认后，重新检测图标是否仍然存在且 SpawnUID 相同

---

## 数据流

### 空投检测数据流

```
1. 定时器触发 (每1秒)
   TimerManager.mapIconDetectionTimer
   │
   ▼
2. 执行检测循环
   TimerManager:DetectMapIcons()
   │
   ├─▶ 获取当前地图ID
   │   C_Map.GetBestMapForUnit("player")
   │
   ├─▶ 匹配地图数据（MapTracker模块）
   │   MapTracker:GetTargetMapData(currentMapID)
   │   └─ 支持父地图匹配
   │
   ├─▶ 处理地图变化（MapTracker模块）
   │   MapTracker:OnMapChanged(currentMapID, targetMapData, currentTime)
   │
   ├─▶ 检测图标（IconDetector模块）
   │   IconDetector:DetectIcon(currentMapID)
   │   └─ 返回 {detected, objectGUID, spawnUID, vignetteGUID, vignetteID}
   │
   ├─▶ SpawnUID 比对
   │   └─ 检查是否是已知事件（currentAirdropSpawnUID == spawnUID）
   │
   ├─▶ 2秒确认机制
   │   └─ 首次检测记录时间，持续检测2秒后确认
   │
   ├─▶ 30秒通知限制
   │   └─ 检查是否允许发送通知（基于 currentAirdropTimestamp）
   │
   └─▶ 处理确认的空投事件
       ├─ 重新检测图标（双重验证）
       ├─ 发送通知（如果需要）
       ├─ 更新刷新时间
       ├─ 更新 currentAirdropSpawnUID 和 currentAirdropTimestamp
       └─ 清除检测状态

8. 更新UI
   MainPanel:UpdateTable()
```

### 位面检测数据流

```
1. 触发事件
   - ZONE_CHANGED
   - ZONE_CHANGED_NEW_AREA
   - PLAYER_TARGET_CHANGED
   - Tooltip显示（鼠标悬停NPC）
   │
   ▼
2. 更新位面信息
   Phase:UpdatePhaseInfo()
   │
   ├─▶ 获取当前地图ID
   │   Area:GetCurrentMapId()
   │
   ├─▶ 匹配地图数据
   │   Data:GetAllMaps() 然后遍历匹配
   │
   └─▶ 获取位面ID
       Phase:GetLayerFromNPC()
       │
       ├─▶ UnitGUID("mouseover") 或 UnitGUID("target")
       │
       └─▶ 解析GUID提取位面信息
           strsplit("-", guid)
           │
           ▼
3. 更新地图数据和发送系统消息
   │
   ├─▶ 记录实时检测到的位面ID（不存储）
   │   targetMapData.currentPhaseID = currentPhaseID
   │
   ├─▶ 首次获取位面ID：发送系统消息
   │   └─ "【地图名】当前位面ID：|cffffff00XX|r"
   │
   ├─▶ 位面变化：发送系统消息
   │   └─ "【地图名】当前位面ID已变更为：|cffffff00XX|r"
   │
   └─▶ 更新UI显示（用于与存储的位面ID比较，不同则红色显示）
       MainPanel:UpdateTable()
```

### 手动输入数据流

```
1. 用户点击"上次刷新"列
   MainPanel:EditLastRefresh(mapId)
   │
   ▼
2. 弹出输入框
   StaticPopup_Show('CRATETRACKERZK_EDIT_LASTREFRESH')
   │
   ▼
3. 用户输入时间
   格式: HH:MM:SS 或 HHMMSS
   │
   ▼
4. 解析时间输入
   Utils.ParseTimeInput(input)
   │
   ├─▶ 解析格式1: HH:MM:SS
   └─▶ 解析格式2: HHMMSS
       │
       ▼
5. 转换为时间戳
   Utils.GetTimestampFromTime(hh, mm, ss)
   │
   └─▶ time(dateTable)
       │
       ▼
6. 更新计时器
   TimerManager:StartTimer(mapId, MANUAL_INPUT, timestamp)
   │
   ├─▶ 设置手动输入锁定
   │   Data.manualInputLock[mapId] = timestamp
   │
   └─▶ 更新刷新时间
       Data:SetLastRefresh(mapId, timestamp)
       │
       ▼
7. 更新UI
   MainPanel:UpdateTable()
```

### 数据持久化流程

#### 保存流程

```
数据更新
   │
   ▼
Data:SaveMapData(mapId)
   │
   ├─▶ 确保数据库存在
   │   ensureDB()
   │
   └─▶ 保存到 SavedVariables
       CRATETRACKERZK_DB.mapData[mapID] = {
         lastRefreshPhase = ...,  -- 上次刷新时的位面ID（从空投的 objectGUID 中提取）
         lastRefresh = ...,
         createTime = ...,
         currentAirdropSpawnUID = ...,
         currentAirdropTimestamp = ...
       }
```

#### 加载流程

```
插件初始化
   │
   ▼
Data:Initialize()
   │
   ├─▶ 确保数据库存在
   │   ensureDB()
   │
   ├─▶ 从配置加载地图列表
   │   MAP_CONFIG.current_maps
   │
   ├─▶ 从保存数据恢复
   │   CRATETRACKERZK_DB.mapData[mapID]
   │
   ├─▶ 验证时间戳
   │   sanitizeTimestamp(savedData.lastRefresh)
   │
   └─▶ 计算下次刷新时间
       Data:UpdateNextRefresh(mapId)
```

---

## API参考

### 地图系统 API (C_Map)

- `C_Map.GetBestMapForUnit(unit)` - 获取指定单位所在的最佳地图ID
- `C_Map.GetMapInfo(mapID)` - 获取指定地图的详细信息

### 小地图图标系统 API (C_VignetteInfo)

- `C_VignetteInfo.GetVignettes()` - 获取当前地图上所有小地图图标的GUID列表
- `C_VignetteInfo.GetVignetteInfo(vignetteGUID)` - 获取指定vignette的详细信息

### 定时器系统 API (C_Timer)

- `C_Timer.After(delay, callback)` - 延迟执行回调函数
- `C_Timer.NewTicker(interval, callback)` - 创建周期性定时器

### 区域检测 API

- `IsIndoors()` - 判断玩家是否在室内
- `GetInstanceInfo()` - 获取当前副本信息（副本类型等）

### 单位系统 API

- `UnitGUID(unit)` - 获取单位的GUID（全局唯一标识符）

### 聊天系统 API

- `SendChatMessage(message, chatType)` - 发送聊天消息
- `DEFAULT_CHAT_FRAME:AddMessage(message)` - 向默认聊天框添加消息

### UI框架 API

- `CreateFrame(frameType, name, parent, template)` - 创建UI框架
- `frame:SetScript(scriptType, handler)` - 设置框架脚本处理器
- `frame:RegisterEvent(event)` - 注册游戏事件
- `frame:RegisterForDrag(button)` - 注册拖拽事件
- `frame:SetPoint(point, relativeTo, relativePoint, x, y)` - 设置框架锚点位置
- `frame:Show() / frame:Hide()` - 显示/隐藏框架

### 工具提示 API

- `GameTooltip:SetOwner(owner, anchor)` - 设置工具提示的所有者和锚点
- `GameTooltip:SetText(text)` - 设置工具提示文本
- `TooltipDataProcessor.AddTooltipPostCall(dataType, callback)` - 添加工具提示后处理回调

### 组队系统 API

- `IsInRaid()` - 判断是否在团队中
- `IsInGroup(category)` - 判断是否在队伍中
- `LE_PARTY_CATEGORY_INSTANCE` - 队伍类别枚举（副本队伍）

### 时间处理 API

- `time()` - 获取当前Unix时间戳
- `date(format, timestamp)` - 格式化时间戳为日期字符串

### 字符串处理 API

- `strsplit(delimiter, str)` - 分割字符串
- `string.match(str, pattern)` - 字符串模式匹配

### 数据持久化

- `SavedVariables` - 插件数据持久化存储
  - 变量名: `CRATETRACKERZK_DB`, `CRATETRACKERZK_UI_DB`

---

**最后更新**：2024-12-29  
**维护者**：capzk

---

## 最新更新（2024-12-29）

### 位面检测系统消息提醒
- 首次获取到位面ID时发送系统消息："【地图名】当前位面ID：|cffffff00XX|r"
- 位面发生变化时发送系统消息："【地图名】当前位面ID已变更为：|cffffff00XX|r"
- 所有消息已本地化（zhCN/zhTW/enUS/ruRU）

### 无效空投提示简化
- 统一为一条系统消息："【地图名】 检测到无效空投事件，空投飞机存在时间过短，判定为无效事件。"
- 移除详细原因说明（图标消失时间、SpawnUID变化等）
- 只发送系统消息，不发送团队通知

### clear命令数据清除完善
- 清除所有定时器、UI框架、内存状态
- 确保完全重新初始化插件

### 全新安装和跨角色状态清理
- 确保全新安装时正确初始化
- 防止跨角色状态污染

