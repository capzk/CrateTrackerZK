# CrateTrackerZK 开发文档

## 目录

1. [分支管理指南](#分支管理指南)
2. [变更日志](#变更日志)
3. [开发指南](#开发指南)

---

## 分支管理指南

### 分支说明

#### main 分支（正式版）
- **用途**：正式发布版本
- **版本号格式**：`x.y.z`（如：`1.0.6`）
- **要求**：
  - 版本号必须是纯数字格式（x.y.z）
  - 不能包含 `-dev`, `-alpha`, `-beta` 等后缀
  - 代码必须经过测试，稳定可用
- **发布**：GitHub Actions 会自动检测版本号变化并创建 Release

#### dev 分支（开发版）
- **用途**：开发测试版本
- **版本号格式**：`x.y.z-dev`（如：`1.0.6-dev`）
- **要求**：
  - 版本号必须包含 `-dev` 后缀
  - 用于开发、测试新功能
  - 不自动发布 Release
- **发布**：不会触发 GitHub Actions 自动发布

### 版本号规范

#### 正式版本号（main 分支）
```
## Version: 1.0.6
```
- ✅ 正确格式：`1.0.6`, `1.1.0`, `2.0.0`
- ❌ 错误格式：`1.0.6-dev`, `1.0.6-alpha`, `1.0.6-beta`

#### 开发版本号（dev 分支）
```
## Version: 1.0.6-dev
```
- ✅ 正确格式：`1.0.6-dev`, `1.0.7-dev`, `1.1.0-dev`
- ❌ 错误格式：`1.0.6`（开发版必须带后缀）

### 工作流程

#### 开发新功能
1. 在 `dev` 分支开发
2. 版本号设置为 `x.y.z-dev`（如：`1.0.7-dev`）
3. 提交并推送到 `dev` 分支
4. 测试功能

#### 发布正式版
1. 将 `dev` 分支合并到 `main` 分支
2. 修改版本号为正式版本号（移除 `-dev` 后缀）
3. 更新所有文件中的版本号：
   - `CrateTrackerZK.toc`
   - `InfoText.lua`
   - `README.md`
4. 提交并推送到 `main` 分支
5. GitHub Actions 自动检测版本变化并创建 Release

### GitHub Actions 检查

工作流会自动检查：
1. ✅ 当前分支是否为 `main`
2. ✅ 版本号格式是否为 `x.y.z`（纯数字）
3. ✅ 版本号是否包含开发后缀（如有则拒绝）
4. ✅ 版本号是否发生变化

只有通过所有检查，才会创建 Release。

---

## 变更日志

### [1.1.4.20251229_beta] - 2024-12-29

#### 新增功能
- **位面检测系统消息提醒**
  - 首次获取到位面ID时发送系统消息："【地图名】当前位面ID：|cffffff00XX|r"
  - 位面发生变化时发送系统消息："【地图名】当前位面ID已变更为：|cffffff00XX|r"
  - 所有消息已本地化（zhCN/zhTW/enUS/ruRU）

#### 优化
- **无效空投提示简化**
  - 统一为一条系统消息："【地图名】 检测到无效空投事件，空投飞机存在时间过短，判定为无效事件。"
  - 移除详细原因说明（图标消失时间、SpawnUID变化等）
  - 只发送系统消息，不发送团队通知
- **clear命令数据清除完善**
  - 清除所有定时器（地图图标检测、位面检测、UI更新）
  - 清除所有UI框架（主面板、浮动按钮）
  - 清除所有模块的内存状态（包括 `currentPhaseID`、`lastNotifyClickTime`、`TeamMessageReader.chatFrame` 等）
  - 确保完全重新初始化插件
- **全新安装初始化**
  - 确保 `CRATETRACKERZK_DB` 和 `CRATETRACKERZK_UI_DB` 在 `OnLogin()` 中正确初始化
  - 确保 `currentPhaseID` 在 `Data:Initialize()` 中初始化为 `nil`
- **跨角色状态清理**
  - 在 `OnLogin()` 中清除所有内存状态，防止跨角色污染
  - 包括所有地图数据的 `currentPhaseID`、`MainPanel.lastNotifyClickTime`、定时器状态等

### [1.1.3-rev1] - 2024-12-29

#### 重大重构
- **基于 objectGUID 去重机制**：
  - 删除 DetectionState 状态机模块，改为2秒确认机制（临时状态）
  - 实现基于完整 objectGUID 的去重机制，防止同一空投事件重复检测
  - 位面信息不再存储，改为在UI层从 `currentAirdropObjectGUID` 实时提取
  - 移除所有冷却机制，改为基于时间戳的30秒通知限制
  - 实现单次更新原则：一个空投事件只允许更新一次时间

#### 新增功能
- **团队消息读取功能**：自动识别团队中的空投消息，自动更新刷新时间
- **消息格式区分**：自动检测消息和手动通知消息使用不同格式

#### 优化
- **刷新按钮UI响应优化**：立即更新UI显示，异步保存数据
- **位面信息提示优化**：首次获取位面ID不再显示提示信息
- **本地化文本优化**：统一使用简洁的默认值

### [1.1.3] - 2024年

#### 优化
- **刷新按钮UI响应优化**
  - 修复了刷新按钮有时需要点击两次才生效的问题
  - 实现了立即UI更新机制：点击刷新按钮后立即更新内存数据和UI显示
  - 数据保存改为异步处理，确保UI响应不受数据保存操作影响
  - 提升了用户体验，刷新操作立即生效，无需等待

- **位面信息提示优化**
  - 首次获取位面ID不再显示提示信息，仅在调试模式下显示
  - 只有位面发生变化时才显示提醒信息
  - 减少了不必要的提示信息干扰

- **本地化文本优化**
  - 将 `NotAcquired` 和 `NoRecord` 统一为简洁的 "N/A" 和 "--:--"
  - 所有语言文件统一使用简洁的默认值，避免长文本显示不协调

### [1.1.2-rev.2] - 2024年

#### 修复
- **修复误判处理重复实现**（已重构）
  - 移除了 Timer.lua 中重复的误报检测逻辑
  - 注：DetectionState 模块已在后续重构中删除，改为2秒确认机制

- **修复 GetState() 无法正确返回 CONFIRMED 状态**（已重构）
  - 注：DetectionState 模块已在后续重构中删除，改为基于 SpawnUID 的去重机制

#### 优化
- **空投事件持续时间识别机制**（已重构）
  - 注：状态机机制已在后续重构中删除，改为基于 SpawnUID 的去重机制和30秒通知限制

- **启动信息优化**
  - 只显示两条核心启动信息（使用绿色 SUCCESS 级别）
  - 其他初始化信息移至调试模式显示

- **区域有效性检测优化**
  - 移除了室内区域判断，室内不再被视为无效区域
  - 现在只有副本/战场类型区域会被判定为无效

### [1.1.2-rev.1] - 重复检测修复与状态管理优化

#### 优化
- **重复检测问题修复**
  - **首次检测立即通知，2秒确认后更新时间**：
    - 首次检测到空投图标时立即发送通知（检查冷却期）
    - 不立即更新时间，等待2秒持续检测确认
    - 2秒确认后更新时间，不再次发送通知
    - 提高响应速度，避免重复通知
  - **通知冷却期机制**：
    - 同一地图在120秒（2分钟）内不重复发送通知
    - 冷却期仅在首次检测时检查
    - 时间更新不受冷却期影响
  - **消失确认期机制**：
    - 已确认的空投需要持续消失5秒才清除状态
    - 防止因地图切换或API延迟导致的误清除
  - **离开地图状态自动清除**：
    - 当玩家离开某个地图后，如果5分钟内没有回到该地图，自动清除该地图的检测状态
    - 避免长期占用内存，保持状态准确性

#### 修复
- **数据清除逻辑完善**
  - 修复 `Commands:HandleClearCommand()` 未清除所有模块状态的问题
  - 确保 `/ctk clear` 命令能完整清除所有状态（包括定时器、UI框架、内存状态、聊天框架等）
  - 添加 `TeamMessageReader.chatFrame` 的清理逻辑
  - 添加所有地图数据中 `currentPhaseID` 的清除逻辑
- **全新安装初始化**
  - 确保 `CRATETRACKERZK_DB` 和 `CRATETRACKERZK_UI_DB` 在 `OnLogin()` 中正确初始化
  - 确保 `currentPhaseID` 在 `Data:Initialize()` 中初始化为 `nil`
- **跨角色状态清理**
  - 在 `OnLogin()` 中清除所有内存状态，防止跨角色污染
  - 包括 `currentPhaseID`、`lastNotifyClickTime`、`phaseTimerPaused` 等所有非持久化状态

---

## 开发指南

### 添加新地图

1. 在 `Data/MapConfig.lua` 的 `current_maps` 中添加配置
2. 在 `Locales/*.lua` 的 `MapNames` 中添加地图名称翻译
3. 无需修改其他代码

### 添加新语言

1. 创建 `Locales/xxXX.lua` 文件
2. 在 `Load.xml` 中添加加载语句（在 enUS.lua 之前）
3. 实现完整的翻译表（参考 enUS.lua）

### 修改检测逻辑

**关键文件**：
- `Modules/Timer.lua` - 检测循环协调（2秒确认机制）
- `Modules/IconDetector.lua` - 图标检测（提取 objectGUID、SpawnUID 和位面ID）
- `Modules/TeamMessageReader.lua` - 团队消息处理

**注意事项**：
- 保持2秒确认机制的完整性
- 注意防误触机制（SpawnUID 比对、30秒通知限制）
- 考虑跨角色状态隔离
- 单次更新原则：一个空投事件只允许更新一次时间

### 调试技巧

1. 开启调试模式：`/ctk debug on`
2. 查看日志输出（带颜色和模块前缀）
3. 使用限流日志避免刷屏
4. 检查检测状态（TimerManager.detectionState）
5. 检查 SpawnUID 比对结果

### 性能优化

#### 检测限流
- 地图图标检测: 每1秒一次
- 位面检测: 事件触发 + 10秒定时器
- UI更新: 每1秒一次
- 状态汇总报告: 每30秒一次
- 调试消息限流:
  - 高频消息（检测循环）: 5秒限流
  - 关键信息（状态变化、地图匹配）: 不限流
  - 普通信息: 20-30秒限流
  - 位面检测信息: 10秒限流
  - 区域检查信息: 30秒限流
  - UI更新: 300秒限流

#### 区域检测优化
- 只在区域变化时检查有效性
- 无效区域自动暂停所有检测
- 减少不必要的API调用

#### 数据持久化
- 只在数据变化时保存
- 使用 SavedVariables 自动持久化
- 时间戳验证防止无效数据

---

**最后更新**：2024-12-29  
**维护者**：capzk

---

## 最新更新（2024-12-29）

### 位面检测系统消息提醒
- 首次获取到位面ID时发送系统消息
- 位面发生变化时发送系统消息
- 所有消息已本地化

### 无效空投提示简化
- 统一为一条系统消息
- 只发送系统消息，不发送团队通知

### clear命令数据清除完善
- 清除所有定时器、UI框架、内存状态
- 确保完全重新初始化插件

### 全新安装和跨角色状态清理
- 确保全新安装时正确初始化
- 防止跨角色状态污染

