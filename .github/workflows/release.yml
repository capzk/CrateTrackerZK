name: Auto Release

on:
  push:
    branches:
      - main

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get current version
        id: get-version
        run: |
          VERSION=$(grep "^## Version:" CrateTrackerZK.toc | sed 's/^## Version:[[:space:]]*//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"
          
          # 检查版本号格式，确保是正式版本（不包含 -dev, -alpha, -beta 等后缀）
          if [[ "$VERSION" =~ -(dev|alpha|beta|rc|test) ]]; then
            echo "⚠️ 检测到开发版本号: $VERSION"
            echo "正式版本号不应包含 -dev, -alpha, -beta 等后缀"
            echo "请确保 main 分支使用正式版本号格式（如: 1.1.1）"
            exit 1
          fi
          
          # 验证版本号格式（应该是 x.y.z 格式）
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "⚠️ 版本号格式不正确: $VERSION"
            echo "正式版本号应为 x.y.z 格式（如: 1.1.1）"
            exit 1
          fi
          
          echo "✓ 版本号格式验证通过: $VERSION"

  create-release:
    needs: check-version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: get-version
        run: |
          VERSION=$(grep "^## Version:" CrateTrackerZK.toc | sed 's/^## Version:[[:space:]]*//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Create release package
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          PACKAGE_DIR="CrateTrackerZK"
          PACKAGE_NAME="CrateTrackerZK.zip"
          
          # 创建插件目录
          mkdir -p "${PACKAGE_DIR}"
          
          # 复制根目录文件
          cp CrateTrackerZK.toc "${PACKAGE_DIR}/" 2>/dev/null || true
          cp Load.xml "${PACKAGE_DIR}/" 2>/dev/null || true
          cp README.md "${PACKAGE_DIR}/" 2>/dev/null || true
          cp CHANGELOG.md "${PACKAGE_DIR}/" 2>/dev/null || true
          
          # 复制所有目录（排除 docs 目录）
          for dir in Core Data Modules UI Utils Locales Media Libs; do
            if [ -d "$dir" ]; then
              cp -r "$dir" "${PACKAGE_DIR}/"
            fi
          done
          
          # 创建ZIP文件（压缩目录本身，解压后得到CrateTrackerZK目录）
          zip -r "${PACKAGE_NAME}" "${PACKAGE_DIR}" -q
          
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "Created package: ${PACKAGE_NAME}"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get-version.outputs.version }}
          name: CrateTrackerZK v${{ steps.get-version.outputs.version }}
          body: |
            ## CrateTrackerZK v${{ steps.get-version.outputs.version }}
            
            ### 安装说明
            
            1. 下载 `CrateTrackerZK.zip`
            2. 解压到魔兽世界插件目录：
               ```
               World of Warcraft\_retail_\Interface\AddOns\CrateTrackerZK
               ```
            3. 重启游戏或使用 `/reload` 命令
            
            ### 更新内容
            
            查看 [提交历史](https://github.com/${{ github.repository }}/compare/v${{ steps.get-version.outputs.version }}...main) 了解详细变更。
            
            ### 使用说明
            
            查看 [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) 了解详细使用方法。
          files: |
            CrateTrackerZK.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
